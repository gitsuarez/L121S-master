<?php  $currentUser = erLhcoreClassUser::instance(); ?><div class="btn-group pull-right" role="group" aria-label="..."><?php  if ($currentUser->hasAccessTo('lhchat','administrateconfig')) : ?><a href="/richard/sites/live121support.com-master/index.php/site_admin/chat/geoconfiguration" class="btn btn-default btn-xs">GEO detection configuration</a></li><?php  endif; ?><?php  if ($currentUser->hasAccessTo('lhchat','allowclearonlinelist')) : ?><a class="btn btn-danger btn-xs csfr-required" onclick="return confirm('Are you sure?')" href="/richard/sites/live121support.com-master/index.php/site_admin/chat/onlineusers/(clear_list)/1">Clear list</a></li><?php  endif; ?></div><h1>Online visitors</h1><?php  if ($tracking_enabled == false) : ?><p>User tracking is disabled, enable it at&nbsp;-&nbsp;<a href="/richard/sites/live121support.com-master/index.php/site_admin/chat/editchatconfig/track_online_visitors">Chat configuration</a></p><?php  endif; ?><?php   $browserNotification = (int)erLhcoreClassModelUserSetting::getSetting('new_user_bn',(int)(0)); $soundUserNotification = (int)erLhcoreClassModelUserSetting::getSetting('new_user_sound',(int)(0)); $onlineDepartment = (int)erLhcoreClassModelUserSetting::getSetting('o_department',(int)(0)); $ouserTimeout = (int)erLhcoreClassModelUserSetting::getSetting('ouser_timeout',(int)(3600)); $oupdTimeout = (int)erLhcoreClassModelUserSetting::getSetting('oupdate_timeout',(int)(10)); $omaxRows = (int)erLhcoreClassModelUserSetting::getSetting('omax_rows',(int)(50)); $ogroupBy = (string)erLhcoreClassModelUserSetting::getSetting('ogroup_by','none'); $omapDepartment = (int)erLhcoreClassModelUserSetting::getSetting('omap_depid',0); $omapMarkerTimeout = (int)erLhcoreClassModelUserSetting::getSetting('omap_mtimeout',30); $onlineCheck = (int)'0'; if ($onlineCheck > 0) { $onlineCheck = ",online_user:(ou.last_check_time_ago < " . ($onlineCheck+3) . ")"; } else { $onlineCheck = ''; } ?><div ng-controller="OnlineCtrl as online" ng-init='groupByField = <?php  echo json_encode($ogroupBy)?>;online.maxRows=<?php  echo (int)$omaxRows?>;online.updateTimeout=<?php  echo (int)$oupdTimeout?>;online.userTimeout = <?php  echo (int)$ouserTimeout?>;online.department=<?php  echo (int)$onlineDepartment?>;online.soundEnabled=<?php  echo $soundUserNotification == 1 ? 'true' : 'false'?>;online.notificationEnabled=<?php  echo $browserNotification == 1 ? 'true' : 'false'?>'><div role="tabpanel" id="tabs"><!-- Nav tabs -->
<ul class="nav nav-pills" role="tablist"><li role="presentation" class="active"><a href="#onlineusers" aria-controls="onlineusers" role="tab" data-toggle="tab" title="Online visitors list"><i class="material-icons">face</i></a></li><li role="presentation"><a id="map-activator" href="#map" aria-controls="map" role="tab" data-toggle="tab" title="Online visitors on map"><i class="material-icons">place</i></a></li></ul><!-- Tab panes -->
<div class="tab-content" id="online-users-dashboard"><div role="tabpanel" class="tab-pane active" id="onlineusers"><?php  $chat_onlineusers_section_online_users_enabled = true?><?php  if ($chat_onlineusers_section_online_users_enabled == true && $currentUser->hasAccessTo('lhchat', 'use_onlineusers') == true) : ?><div class="row"><div class="col-sm-2 form-group col-xs-6 pr5"><label id="online-users-count" title="online users">{{online.onlineusers.length}}</label><div class="pull-right"><ul class="list-inline pull-right user-settings-list"><li class="li-icon"><a href="#" ng-click="online.disableNewUserSound()"><i class="material-icons" title="Enable/Disable sound about new visitor">{{online.soundEnabled ? 'volume_up':'volume_off'}}</i></a></li><li class="li-icon"><a href="#" ng-click="online.disableNewUserBNotif()"><i class="material-icons"  title="Enable/Disable browser notifications about new visitor">{{online.notificationEnabled ? 'visibility' : 'visibility_off'}}</i></a></li></ul></div></div><div class="col-sm-2 form-group col-xs-6 pl5 pr5"><input class="form-control input-sm" ng-model="query" type="text" value="" placeholder="Type to search"></div><div class="col-sm-2 form-group col-xs-6 pl5 pr5"><select class="form-control input-sm" ng-model="groupByField" title="Group list by"><option value="none">Group by</option><option value="user_country_name">User country</option><option value="current_page">Page</option><option value="page_title">Page title</option><option value="referrer">Referrer</option><option value="identifier">Identifier</option><option value="dep_id">Department</option></select></div><div class="col-sm-2 form-group col-xs-6 pl5 pr5"><?php   echo erLhcoreClassRenderHelper::renderCombobox( array ( 'input_name' => 'department_id', 'optional_field' => 'Select department', 'selected_id' => 0, 'css_class' => 'form-control input-sm', 'ng-model' => 'online.department', 'list_function' => 'erLhcoreClassModelDepartament::getList', 'list_function_params' => $departmentParams )); ?></div><div class="col-sm-2 form-group col-xs-6 pl5 pr5"><select class="form-control input-sm" id="updateTimeout" ng-model="online.updateTimeout" title="Refresh list every"><option value="1">1 second</option><option value="3">3 seconds</option><option value="5">5 seconds</option><option value="10">10 seconds</option></select></div><div class="col-sm-1 form-group col-xs-6 pl5 pr5"><select class="form-control input-sm" id="userTimeout" ng-model="online.userTimeout" title="Show visitors who visited site in the past"><option value="30">30 seconds</option><option value="60">1 minute</option><option value="120">2 minutes</option><option value="300">5 minutes</option><option value="600">10 minutes</option><option value="1200">20 minutes</option><option value="1800">30 minutes</option><option value="3600">1 hour</option><option value="86400">1 day</option><option value="604800">7 days</option><option value="2678400">31 day</option></select></div><div class="col-sm-1 form-group col-xs-12 pl5"><select class="form-control input-sm" id="maxRows" ng-model="online.maxRows" title="Max records to return"><option value="50">50</option><option value="100">100</option><option value="150">150</option><option value="200">200</option><option value="250">250</option><option value="300">300</option><option value="500">500</option><option value="1000">1000</option></select></div></div><table ng-cloak class="table table-condensed online-users-table" cellpadding="0" cellspacing="0" ng-init='trans = <?php  echo json_encode(array('third' => 'User has not seen a message from the operator, or the message window is still open.','msg_seen' => 'Seen','msg_not_seen' => 'Unseen','second' => 'User has seen the message from the operator.','first' => 'User does not have any messages from the operator'),JSON_HEX_APOS)?>'><thead><tr><th width="50%" colspan="2"><a class="material-icons" ng-click="online.predicate = 'last_visit'; online.reverse=!online.reverse" title="Last activity" >access_time</a><a class="material-icons" ng-click="online.predicate = 'time_on_site'; online.reverse=!online.reverse" title="Time on site">access_time</a><a class="material-icons" ng-click="online.predicate = 'visitor_tz_time'; online.reverse=!online.reverse" title="Visitor local time">access_time</a><?php  if ('0' == 1) : ?><a class="material-icons" ng-click="online.predicate = 'last_check_time'; online.reverse=!online.reverse" title="By user status on site">access_time</a><?php  endif;?><a href="" ng-click="online.predicate = 'current_page'; online.reverse=!online.reverse" />Page</a> | <a href="" ng-click="online.predicate = 'referrer'; online.reverse=!online.reverse" />Came from</a></th><th width="1%">Action</th></tr></thead><tbody ng-repeat="group in onlineusersGrouped track by group.id"><tr ng-show="group.label != ''"><td colspan="6"><h5 class="group-by-{{groupByField}}">{{group.label}} ({{group.ou.length}})</h5></td></tr><tr ng-repeat="ou in group.ou | orderBy:online.predicate:online.reverse | filter:query track by ou.id" ng-class="{recent_visit:(ou.last_visit_seconds_ago < 15)<?php  echo $onlineCheck?>}"><td nowrap><div>{{ou.lastactivity_ago}} ago<br/><span class="fs-11">{{ou.time_on_site_front}}</span></div></td><td><div class="btn-group" role="group" aria-label="..."><a class="btn btn-xs btn-default" ng-class="{'icon-user-away': ou.online_status == 1, 'icon-user-online': ou.online_status == 0}" data-popover-content="popover-content-ou" data-popover-title="popover-title-ou" data-chat-id="{{ou.id}}" data-toggle="popover" data-placement="right" ng-click="online.showOnlineUserInfo(ou.id)"><i class="material-icons">info_outline</i><img ng-if="ou.user_country_code != ''" ng-src="/richard/sites/live121support.com-master/design/defaulttheme/images/flags/{{ou.user_country_code}}.png" alt="{{ou.user_country_name}}" /></a><?php   ?><span ng-click="online.previewChat(ou)" class="btn btn-xs btn-success action-image" ng-show="ou.chat_id > 0"><i class="material-icons">chat</i>Chat</span><span class="btn btn-xs btn-info" ng-show="ou.total_visits > 1"><i class="material-icons">face</i>Returning ({{ou.total_visits}})</span><span class="btn btn-success btn-xs" ng-show="ou.total_visits == 1"><i class="material-icons">face</i>New</span><span title="{{ou.operator_user_string}} has sent a message to the user" class="btn btn-xs" ng-show="ou.operator_message != ''" ng-class="ou.message_seen == 1 ? 'btn-success' : 'btn-danger'"><i class="material-icons">chat_bubble_outline</i>{{ou.message_seen == 1 ? trans.msg_seen : trans.msg_not_seen}}</span><span class="btn btn-xs btn-primary up-case-first" ng-if="ou.user_country_code != ''">{{ou.user_country_name}}{{ou.city != '' ? ' | '+ou.city : ''}}</span><span class="btn btn-primary btn-xs"><i class="material-icons">access_time</i>{{ou.visitor_tz}} - {{ou.visitor_tz_time}}</span></div><div id="popover-title-ou-{{ou.id}}" class="hide" ng-if="ou.user_country_code != ''"><span class="up-case-first"><i class="material-icons">place</i> {{ou.user_country_name}}{{ou.city != '' ? ' | '+ou.city : ''}}</span></div><div id="popover-content-ou-{{ou.id}}" class="hide"><ul class="list-unstyled"><li><i class="material-icons">access_time</i>{{ou.visitor_tz}} - {{ou.visitor_tz_time}}</li><li>{{ou.notes_intro}}<li><i class="material-icons">access_time</i>{{ou.first_visit_front}} - first visit<li><i class="material-icons">access_time</i>{{ou.last_visit_front}} - last visit<li><i class="material-icons">&#xE8A0;</i>Pageviews - {{ou.pages_count}} {{ou.identifier != '' ? ' Identifier - '+ou.identifier : ''}} | Last activity {{ou.lastactivity_ago}} ago | Time on site <span class="fs-11">{{ou.time_on_site_front}}</span><li><i class="material-icons">&#xE1B1;</i>{{ou.user_agent}} | IP: {{ou.ip}}</ul></div><div class="abbr-list pt5" ng-if="ou.page_title || ou.current_page"><i class="material-icons" title="Page">&#xE8A0;</i><a target="_blank" href="{{ou.current_page}}" title="{{ou.current_page}}">{{ou.page_title || ou.current_page}}</a></div><div class="abbr-list pt5" ng-if="ou.referrer != ''"><i class="material-icons" title="From">&#xE8A0;</i><a target="_blank" href="http:{{ou.referrer}}" title="{{ou.referrer}}">{{ou.referrer}}</a></div></td><td><div style="width:90px"><div class="btn-group" role="group" aria-label="..."><?php  $system_configuration_proactive_enabled = true;?><?php  if ($system_configuration_proactive_enabled == true) : ?><a ng-click="online.sendMessage(ou.id)" class="btn btn-default btn-sm material-icons mat-100 mr-0" title="Send message">chat</a><?php  endif;?><a ng-click="online.deleteUser(ou,'Are you sure?');" class="btn btn-danger btn-sm material-icons mat-100 mr-0" title="Delete, ID - {{ou.id}}">delete</a></div></div></td></tr></tbody></table><?php  endif;?></div><div role="tabpanel" class="tab-pane" id="map"><?php  $chat_onlineusers_section_map_online_enabled = true?><?php  if ($chat_onlineusers_section_map_online_enabled == true) : ?><div class="row form-group"><div class="col-xs-6"><img data-toggle="tooltip" data-placement="bottom" class="tip-right" title="User is chatting" src="/richard/sites/live121support.com-master/design/defaulttheme/images/icons/home-chat.png" /><img data-toggle="tooltip" data-placement="bottom" class="tip-right" title="User does not have any message from operator" src="/richard/sites/live121support.com-master/design/defaulttheme/images/icons/home-unsend.png" /><img data-toggle="tooltip" data-placement="bottom" class="tip-right" title="User has message from operator" src="/richard/sites/live121support.com-master/design/defaulttheme/images/icons/home-send.png" /></div><div class="col-xs-3"><?php  echo erLhcoreClassRenderHelper::renderCombobox( array ( 'input_name' => 'department_map_id', 'optional_field' => 'Select department', 'selected_id' => $omapDepartment, 'css_class' => 'form-control input-sm', 'list_function' => 'erLhcoreClassModelDepartament::getList' )); ?></div><div class="col-xs-3"><select class="form-control input-sm" id="markerTimeout" title="Marker timeout before it dissapears from map"><option value="30" <?php  echo $omapMarkerTimeout == 30 ? 'selected="selected"' : ''?> >30 seconds</option><option value="60" <?php  echo $omapMarkerTimeout == 60 ? 'selected="selected"' : ''?> >1 minute</option><option value="120" <?php  echo $omapMarkerTimeout == 120 ? 'selected="selected"' : ''?> >2 minutes</option><option value="300" <?php  echo $omapMarkerTimeout == 300 ? 'selected="selected"' : ''?> >5 minutes</option><option value="600" <?php  echo $omapMarkerTimeout == 600 ? 'selected="selected"' : ''?> >10 minutes</option></select></div></div><div id="map_canvas" style="height:600px;width:100%;"></div><script type="text/javascript">var GeoLocationData = {zoom:<?php  echo $geo_location_data['zoom']?>,lat:<?php  echo $geo_location_data['lat']?>,lng:<?php  echo $geo_location_data['lng']?>};</script><script async defer src="https://maps.googleapis.com/maps/api/js?<?php  if (erConfigClassLhConfig::getInstance()->getSetting( 'site', 'maps_api_key', false)) {echo 'key=' , erConfigClassLhConfig::getInstance()->getSetting( 'site', 'maps_api_key', false) , '&';} elseif (isset($geo_location_data['gmaps_api_key'])) {echo 'key=' ,$geo_location_data['gmaps_api_key'], '&';}?>callback=gMapsCallback"></script>
<?php  endif;?></div></div></div></div><script>lhinst.protectCSFR();</script><script>$( document ).ready(function() {<?php  if (!isset($popoverInitialized) || $popoverInitialized == false) : ?>$('#dashboard-body, #onlineusers, #map').popover({trigger:'hover',html : true,container: 'body',selector: '[data-toggle="popover"]',content: function () {if ($(this).is('[data-popover-content]')) {return $('#'+$(this).attr('data-popover-content')+'-'+$(this).attr('data-chat-id')).html();} else {return $('#popover-content-'+$(this).attr('data-chat-id')).html();}},title: function () {return  $('#popover-title-'+$(this).attr('data-chat-id')).html();}});<?php  endif; ?>lhinst.attachTabNavigator();$('#right-column-page').removeAttr('id');});<?php $chatsOpen = CSCacheAPC::getMem()->getArray('lhc_open_chats'); if (!empty($chatsOpen)){ $chats = erLhcoreClassChat::getList(array('filterin' => array('id' => $chatsOpen))); $deleteKeys = array_diff($chatsOpen, array_keys($chats)); foreach ($deleteKeys as $chat_id) { CSCacheAPC::getMem()->removeFromArray('lhc_open_chats', $chat_id); } foreach ($chats as $chat ){ if (erLhcoreClassChat::hasAccessToRead($chat)){ echo "lhinst.startChat('$chat->id',$('#tabs'),'".erLhcoreClassDesign::shrt($chat->nick,10,'...',30,ENT_QUOTES)."',false);"; } else { CSCacheAPC::getMem()->removeFromArray('lhc_open_chats', $chat->id); } } } ?></script>